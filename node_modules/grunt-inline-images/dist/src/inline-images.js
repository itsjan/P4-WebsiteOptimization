/**
 * grunt-inline-images
 * https://github.com/EE/grunt-inline-images
 *
 * Author Michał Gołębiowski <michal.golebiowski@laboratorium.ee>
 * Licensed under the MIT license.
 */

'use strict';

var request = require('request');
var urlRegex = require('url-regex');
var detectJsonIndent = require('detect-json-indent');

module.exports = function (grunt) {
    var getRegexFromPattern = function (pattern) {return new RegExp('(?:http(?:s|):|)//(?:www\\.|)' + pattern);};

    var isUrl = function (string) {return typeof string === 'string' && urlRegex({ exact: true }).test(string);};

    var getEncodedImage = function (url) {return (
            new Promise(function (resolve, reject) {
                grunt.log.writeln('Downloading started...', url);
                request({ 
                    url: url, 
                    encoding: null, 
                    timeout: 10000 }, 
                function (error, response, body) {
                    if (error) {
                        grunt.log.error('Error when downloading ' + url + ': ' + error.message);
                        grunt.log.writeln('The URL will be kept intact');
                        grunt.log.writeln(error.stack);
                        return reject(error);}

                    grunt.log.writeln('File downloaded!', url);
                    resolve('data:' + (response.headers['content-type'] || 'image/jpeg') + ';base64,' + 
                    new Buffer(body).toString('base64'));});}));};



    // TODO switch to destructuring when Node 5 arrives.
    //    const transformObject = ({object, toInline, toDiscard, jobs}) => {
    var transformObject = function (params) {
        var object = params.object;
        var toInline = params.toInline;
        var toDiscard = params.toDiscard;
        var jobs = params.jobs;

        var transform = function (obj) {return transformObject({ 
                object: obj, 
                toInline: toInline, toDiscard: toDiscard, jobs: jobs });};


        var newObject = {};var _loop = function (
        key) {
            var value = object[key];
            if (typeof value === 'object' && value != null) {
                newObject[key] = transform(value);} else 
            if (isUrl(value)) {
                for (_iterator = toDiscard, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {if (_isArray) {if (_i >= _iterator.length) break;_ref = _iterator[_i++];} else {_i = _iterator.next();if (_i.done) break;_ref = _i.value;}var pattern = _ref;
                    if (getRegexFromPattern(pattern).test(value)) {
                        newObject[key] = 'about:blank';
                        break;}}


                for (_iterator2 = toInline, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {if (_isArray2) {if (_i2 >= _iterator2.length) break;_ref2 = _iterator2[_i2++];} else {_i2 = _iterator2.next();if (_i2.done) break;_ref2 = _i2.value;}var pattern = _ref2;
                    if (getRegexFromPattern(pattern).test(value)) {
                        jobs.push(
                        getEncodedImage(value).
                        then(function (encodedValue) {
                            newObject[key] = encodedValue;}));


                        // Don't download the same file twice.
                        break;}}} else 


            {
                newObject[key] = value;}};for (var key in object) {var _iterator, _isArray, _i;var _ref;var _iterator2, _isArray2, _i2;var _ref2;_loop(key);}


        return newObject;};


    grunt.registerMultiTask('inlineImages', 
    'Change all URLs matching a pattern to inline base64 representations.', 
    function () {
        var done = this.async();

        // TODO switch to destructuring when Node 5 arrives.
        //            const {toInline = [], toDiscard = []} = this.options();
        var options = this.options();
        var toInline = options.toInline || [];
        var toDiscard = options.toDiscard || [];

        var globalJobs = [];

        this.files.forEach(function (mapping) {
            mapping.src.forEach(function (path) {
                grunt.log.writeln(' ***** Processing file: ' + path + ' ***** ');

                var dest = undefined;
                var contents = grunt.file.read(path);
                var indent = detectJsonIndent(contents);
                var object = JSON.parse(contents);
                var jobs = [];

                if (mapping.dest) {
                    if (mapping.src.length !== 1) {
                        grunt.log.error('Only one source file per destination is supported!');
                        return false;}

                    dest = mapping.dest;} else 
                {
                    // If destination file not provided, write back to the source file.
                    dest = path;}


                var newObject = transformObject({ object: object, toInline: toInline, toDiscard: toDiscard, jobs: jobs });

                globalJobs.push(
                Promise.all(jobs).
                then(function () {
                    // Write transformed contents back into the file.
                    grunt.file.write(dest, JSON.stringify(newObject, null, indent));
                    grunt.log.writeln(' ***** File: ' + 
                    path + ' processed; output written to: ' + 
                    dest + ' ***** ');}));});});





        Promise.all(globalJobs).
        then(function () {
            done();}).

        catch(function () {
            done(false);});});};
//# sourceMappingURL=data:application/json;base64,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Q0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ2hFLHlCQUFLLENBQUMsR0FBRyxDQUFDLE9BQU87QUFDYix3QkFBSTtBQUNKLHdCQUFJLGFBQVcsQ0FBQyxDQUN2QixDQUFDLENBQ1QsQ0FBQyxDQUNMLENBQUMsQ0FBQyxDQUNOLENBQUMsQ0FBQzs7Ozs7O0FBRUgsZUFBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7QUFDbEIsWUFBSSxDQUFDLFlBQU07QUFDUixnQkFBSSxFQUFFLENBQUMsQ0FDVixDQUFDOztBQUNELGFBQUssQ0FBQyxZQUFNO0FBQ1QsZ0JBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUNmLENBQUMsQ0FBQyxDQUNWLENBQ0osQ0FBQyxDQUNMLENBQUMiLCJmaWxlIjoic3JjL2lubGluZS1pbWFnZXMuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL21nb2wvRG9jdW1lbnRzL3Byb2plY3RzL3B1YmxpYy9taW5lL2dydW50LWlubGluZS1pbWFnZXMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIGdydW50LWlubGluZS1pbWFnZXNcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9FRS9ncnVudC1pbmxpbmUtaW1hZ2VzXG4gKlxuICogQXV0aG9yIE1pY2hhxYIgR2/FgsSZYmlvd3NraSA8bWljaGFsLmdvbGViaW93c2tpQGxhYm9yYXRvcml1bS5lZT5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS5cbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0Jyk7XG5jb25zdCB1cmxSZWdleCA9IHJlcXVpcmUoJ3VybC1yZWdleCcpO1xuY29uc3QgZGV0ZWN0SnNvbkluZGVudCA9IHJlcXVpcmUoJ2RldGVjdC1qc29uLWluZGVudCcpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGdydW50ID0+IHtcbiAgICBjb25zdCBnZXRSZWdleEZyb21QYXR0ZXJuID0gcGF0dGVybiA9PiBuZXcgUmVnRXhwKGAoPzpodHRwKD86c3wpOnwpLy8oPzp3d3dcXFxcLnwpJHsgcGF0dGVybiB9YCk7XG5cbiAgICBjb25zdCBpc1VybCA9IHN0cmluZyA9PiB0eXBlb2Ygc3RyaW5nID09PSAnc3RyaW5nJyAmJiB1cmxSZWdleCh7ZXhhY3Q6IHRydWV9KS50ZXN0KHN0cmluZyk7XG5cbiAgICBjb25zdCBnZXRFbmNvZGVkSW1hZ2UgPSB1cmwgPT5cbiAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgZ3J1bnQubG9nLndyaXRlbG4oJ0Rvd25sb2FkaW5nIHN0YXJ0ZWQuLi4nLCB1cmwpO1xuICAgICAgICAgICAgcmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgICAgIGVuY29kaW5nOiBudWxsLFxuICAgICAgICAgICAgICAgIHRpbWVvdXQ6IDEwMDAwLFxuICAgICAgICAgICAgfSwgKGVycm9yLCByZXNwb25zZSwgYm9keSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBncnVudC5sb2cuZXJyb3IoYEVycm9yIHdoZW4gZG93bmxvYWRpbmcgJHsgdXJsIH06ICR7IGVycm9yLm1lc3NhZ2UgfWApO1xuICAgICAgICAgICAgICAgICAgICBncnVudC5sb2cud3JpdGVsbignVGhlIFVSTCB3aWxsIGJlIGtlcHQgaW50YWN0Jyk7XG4gICAgICAgICAgICAgICAgICAgIGdydW50LmxvZy53cml0ZWxuKGVycm9yLnN0YWNrKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGdydW50LmxvZy53cml0ZWxuKCdGaWxlIGRvd25sb2FkZWQhJywgdXJsKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKGBkYXRhOiR7IHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddIHx8ICdpbWFnZS9qcGVnJyB9O2Jhc2U2NCwke1xuICAgICAgICAgICAgICAgICAgICBuZXcgQnVmZmVyKGJvZHkpLnRvU3RyaW5nKCdiYXNlNjQnKSB9YCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAvLyBUT0RPIHN3aXRjaCB0byBkZXN0cnVjdHVyaW5nIHdoZW4gTm9kZSA1IGFycml2ZXMuXG4vLyAgICBjb25zdCB0cmFuc2Zvcm1PYmplY3QgPSAoe29iamVjdCwgdG9JbmxpbmUsIHRvRGlzY2FyZCwgam9ic30pID0+IHtcbiAgICBjb25zdCB0cmFuc2Zvcm1PYmplY3QgPSBwYXJhbXMgPT4ge1xuICAgICAgICBjb25zdCBvYmplY3QgPSBwYXJhbXMub2JqZWN0O1xuICAgICAgICBjb25zdCB0b0lubGluZSA9IHBhcmFtcy50b0lubGluZTtcbiAgICAgICAgY29uc3QgdG9EaXNjYXJkID0gcGFyYW1zLnRvRGlzY2FyZDtcbiAgICAgICAgY29uc3Qgam9icyA9IHBhcmFtcy5qb2JzO1xuXG4gICAgICAgIGNvbnN0IHRyYW5zZm9ybSA9IG9iaiA9PiB0cmFuc2Zvcm1PYmplY3Qoe1xuICAgICAgICAgICAgb2JqZWN0OiBvYmosXG4gICAgICAgICAgICB0b0lubGluZSwgdG9EaXNjYXJkLCBqb2JzLFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBuZXdPYmplY3QgPSB7fTtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gb2JqZWN0KSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG9iamVjdFtrZXldO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIG5ld09iamVjdFtrZXldID0gdHJhbnNmb3JtKHZhbHVlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNVcmwodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBwYXR0ZXJuIG9mIHRvRGlzY2FyZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZ2V0UmVnZXhGcm9tUGF0dGVybihwYXR0ZXJuKS50ZXN0KHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3T2JqZWN0W2tleV0gPSAnYWJvdXQ6YmxhbmsnO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBwYXR0ZXJuIG9mIHRvSW5saW5lKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChnZXRSZWdleEZyb21QYXR0ZXJuKHBhdHRlcm4pLnRlc3QodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBqb2JzLnB1c2goXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0RW5jb2RlZEltYWdlKHZhbHVlKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihlbmNvZGVkVmFsdWUgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3T2JqZWN0W2tleV0gPSBlbmNvZGVkVmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgZG93bmxvYWQgdGhlIHNhbWUgZmlsZSB0d2ljZS5cbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXdPYmplY3Rba2V5XSA9IHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXdPYmplY3Q7XG4gICAgfTtcblxuICAgIGdydW50LnJlZ2lzdGVyTXVsdGlUYXNrKCdpbmxpbmVJbWFnZXMnLFxuICAgICAgICAnQ2hhbmdlIGFsbCBVUkxzIG1hdGNoaW5nIGEgcGF0dGVybiB0byBpbmxpbmUgYmFzZTY0IHJlcHJlc2VudGF0aW9ucy4nLFxuICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBjb25zdCBkb25lID0gdGhpcy5hc3luYygpO1xuXG4gICAgICAgICAgICAvLyBUT0RPIHN3aXRjaCB0byBkZXN0cnVjdHVyaW5nIHdoZW4gTm9kZSA1IGFycml2ZXMuXG4vLyAgICAgICAgICAgIGNvbnN0IHt0b0lubGluZSA9IFtdLCB0b0Rpc2NhcmQgPSBbXX0gPSB0aGlzLm9wdGlvbnMoKTtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMoKTtcbiAgICAgICAgICAgIGNvbnN0IHRvSW5saW5lID0gb3B0aW9ucy50b0lubGluZSB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IHRvRGlzY2FyZCA9IG9wdGlvbnMudG9EaXNjYXJkIHx8IFtdO1xuXG4gICAgICAgICAgICBjb25zdCBnbG9iYWxKb2JzID0gW107XG5cbiAgICAgICAgICAgIHRoaXMuZmlsZXMuZm9yRWFjaChtYXBwaW5nID0+IHtcbiAgICAgICAgICAgICAgICBtYXBwaW5nLnNyYy5mb3JFYWNoKHBhdGggPT4ge1xuICAgICAgICAgICAgICAgICAgICBncnVudC5sb2cud3JpdGVsbihgICoqKioqIFByb2Nlc3NpbmcgZmlsZTogJHsgcGF0aCB9ICoqKioqIGApO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBkZXN0O1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50cyA9IGdydW50LmZpbGUucmVhZChwYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZW50ID0gZGV0ZWN0SnNvbkluZGVudChjb250ZW50cyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9iamVjdCA9IEpTT04ucGFyc2UoY29udGVudHMpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBqb2JzID0gW107XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKG1hcHBpbmcuZGVzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcHBpbmcuc3JjLmxlbmd0aCAhPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdydW50LmxvZy5lcnJvcignT25seSBvbmUgc291cmNlIGZpbGUgcGVyIGRlc3RpbmF0aW9uIGlzIHN1cHBvcnRlZCEnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBkZXN0ID0gbWFwcGluZy5kZXN0O1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgZGVzdGluYXRpb24gZmlsZSBub3QgcHJvdmlkZWQsIHdyaXRlIGJhY2sgdG8gdGhlIHNvdXJjZSBmaWxlLlxuICAgICAgICAgICAgICAgICAgICAgICAgZGVzdCA9IHBhdGg7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdPYmplY3QgPSB0cmFuc2Zvcm1PYmplY3Qoe29iamVjdCwgdG9JbmxpbmUsIHRvRGlzY2FyZCwgam9ic30pO1xuXG4gICAgICAgICAgICAgICAgICAgIGdsb2JhbEpvYnMucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKGpvYnMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXcml0ZSB0cmFuc2Zvcm1lZCBjb250ZW50cyBiYWNrIGludG8gdGhlIGZpbGUuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdydW50LmZpbGUud3JpdGUoZGVzdCwgSlNPTi5zdHJpbmdpZnkobmV3T2JqZWN0LCBudWxsLCBpbmRlbnQpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3J1bnQubG9nLndyaXRlbG4oYCAqKioqKiBGaWxlOiAke1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aCB9IHByb2Nlc3NlZDsgb3V0cHV0IHdyaXR0ZW4gdG86ICR7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0IH0gKioqKiogYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBQcm9taXNlLmFsbChnbG9iYWxKb2JzKVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZG9uZShmYWxzZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICApO1xufTtcbiJdfQ==
